import React, { useState, useEffect } from "react";

// GeoSolidsGamePlus.jsx ‚Äî vers√£o ajustada com 3 minutos iniciais por rodada
// Tempo inicial aumentado e b√¥nus de tempo maior ap√≥s acertos.

const SOLIDS = [
  { id: "cube", name: "Cubo", hint: "6 faces quadradas", volume: (a) => a ** 3, param: "aresta" },
  { id: "rectprism", name: "Paralelep√≠pedo", hint: "Faces retangulares", volume: (a,b,c) => a * b * c, param: ["comprimento", "largura", "altura"] },
  { id: "cylinder", name: "Cilindro", hint: "2 bases circulares", volume: (r,h) => Math.PI * r ** 2 * h, param: ["raio", "altura"] },
  { id: "cone", name: "Cone", hint: "1 base circular + v√©rtice", volume: (r,h) => (Math.PI * r ** 2 * h) / 3, param: ["raio", "altura"] },
  { id: "pyramid", name: "Pir√¢mide", hint: "Base quadrada + faces triangulares", volume: (a,h) => (a ** 2 * h) / 3, param: ["aresta da base", "altura"] },
  { id: "sphere", name: "Esfera", hint: "Superf√≠cie cont√≠nua", volume: (r) => (4/3) * Math.PI * r ** 3, param: "raio" }
];

function shuffle(array) {
  const a = array.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

export default function GeoSolidsGamePlus() {
  const [level, setLevel] = useState(1);
  const [time, setTime] = useState(180); // ‚è±Ô∏è tempo inicial aumentado para 3 minutos (180s)
  const [score, setScore] = useState(0);
  const [currentSolid, setCurrentSolid] = useState(null);
  const [params, setParams] = useState({});
  const [answer, setAnswer] = useState("");
  const [message, setMessage] = useState("");
  const [running, setRunning] = useState(true);

  useEffect(() => {
    nextChallenge();
  }, [level]);

  useEffect(() => {
    if (!running) return;
    if (time <= 0) {
      setRunning(false);
      setMessage("‚è∞ Tempo esgotado! Sua pontua√ß√£o final: " + score);
      return;
    }
    const timer = setTimeout(() => setTime(time - 1), 1000);
    return () => clearTimeout(timer);
  }, [time, running]);

  function nextChallenge() {
    const s = SOLIDS[Math.floor(Math.random() * SOLIDS.length)];
    const randomParams = Array.isArray(s.param) ? s.param.map(() => (Math.floor(Math.random() * 5) + 1)) : [Math.floor(Math.random() * 5) + 1];
    setParams(randomParams);
    setCurrentSolid(s);
    setAnswer("");
    setMessage(`N√≠vel ${level}: Calcule o volume do ${s.name}.`);
  }

  function checkAnswer() {
    if (!currentSolid) return;
    const expected = Array.isArray(params)
      ? currentSolid.volume(...params)
      : currentSolid.volume(params[0]);
    const userValue = parseFloat(answer);
    const tolerance = 0.5; // pequena toler√¢ncia

    if (Math.abs(userValue - expected) <= tolerance) {
      setScore(score + 15 * level);
      setMessage("‚úÖ Correto! +" + 15 * level + " pontos");
      setLevel(level + 1);
      setTime(time + 30); // üî∫ b√¥nus de 30 segundos por acerto
    } else {
      setScore(Math.max(0, score - 5));
      setMessage(`‚ùå Errado! O volume era ${expected.toFixed(2)}. -5 pontos`);
    }
    nextChallenge();
  }

  function resetGame() {
    setLevel(1);
    setScore(0);
    setTime(180); // reinicia com 3 minutos
    setRunning(true);
    nextChallenge();
    setMessage("");
  }

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-yellow-100 via-orange-100 to-pink-100 p-6 animate-fadeIn">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6 text-center border-4 border-orange-400">
        <h1 className="text-3xl font-extrabold mb-2 text-orange-600 drop-shadow">Desafio dos S√≥lidos ‚Äî Vers√£o Plus</h1>
        <div className="flex justify-around mb-4 text-sm font-semibold text-orange-700">
          <div>‚è±Ô∏è Tempo: {time}s</div>
          <div>‚≠ê Pontos: {score}</div>
          <div>üî• N√≠vel: {level}</div>
        </div>

        {currentSolid && (
          <div className="mb-3">
            <div className="font-bold text-xl text-orange-700 mb-1">{currentSolid.name}</div>
            <div className="text-sm text-slate-600 italic">{currentSolid.hint}</div>
            <div className="mt-2 text-sm text-orange-900">Par√¢metros:</div>
            <ul className="text-sm text-slate-700">
              {Array.isArray(currentSolid.param)
                ? currentSolid.param.map((p, i) => (<li key={i}>{p}: {params[i]} cm</li>))
                : (<li>{currentSolid.param}: {params[0]} cm</li>)}
            </ul>
          </div>
        )}

        <input
          type="number"
          value={answer}
          onChange={(e) => setAnswer(e.target.value)}
          placeholder="Digite o volume (cm¬≥)"
          className="border-2 border-orange-400 rounded-md p-2 w-3/4 text-center focus:outline-none focus:ring-4 focus:ring-orange-300"
          disabled={!running}
        />

        <div className="mt-3 space-x-3">
          <button
            onClick={checkAnswer}
            className="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 shadow-md"
            disabled={!running}
          >Verificar</button>

          <button
            onClick={resetGame}
            className="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 shadow-md"
          >Reiniciar</button>
        </div>

        <div className="mt-4 text-sm text-slate-800 min-h-6 font-semibold">{message}</div>
      </div>
    </div>
  );
}
